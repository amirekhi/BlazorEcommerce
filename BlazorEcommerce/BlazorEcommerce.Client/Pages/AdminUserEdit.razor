@inject IClientAdminUserService AdminUserService
@inject NavigationManager Navigation
@inject IJSRuntime JS

@using BlazorEcommerce.Client.Services
@using BlazorEcommerce.DTOs.Entities
@using ClassLibrary1.DTOs.Entities
@rendermode InteractiveWebAssembly

<h2 class="text-2xl font-bold mb-4">Edit User</h2>

@if (user == null)
{
    <p class="text-gray-500">Loading user data...</p>
}
else
{
    <EditForm Model="user" OnValidSubmit="UpdateUser">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="space-y-4">
       <!-- Profile Image Section -->
            <div>
                <label class="block font-medium mb-2 text-gray-800">Profile Image</label>

                <div class="flex items-center gap-4">
                    @if (!string.IsNullOrWhiteSpace(user.ProfileImageUrl))
                    {
                        <img src="@user.ProfileImageUrl"
                            alt="User profile image"
                            class="w-24 h-24 rounded-full border shadow-sm" />
                    }
                    else
                    {
                        <div class="w-24 h-24 rounded-full border bg-gray-200 flex items-center justify-center text-sm text-gray-500">
                            No Image
                        </div>
                    }

                    <label class="cursor-pointer inline-block px-4 py-2 text-sm border border-gray-300 rounded-lg bg-white text-black hover:bg-gray-100 transition whitespace-nowrap">
                        Change Image
                        <InputFile OnChange="HandleFileSelected" class="hidden" />
                    </label>
                </div>

                @if (!string.IsNullOrWhiteSpace(StatusMessage))
                {
                    <p class="text-sm text-gray-600 mt-1">@StatusMessage</p>
                }
            </div>


            <!-- Username -->
            <div>
                <label class="block font-medium mb-1">Username</label>
                <InputText class="w-full px-3 py-2 rounded bg-gray-100 border" @bind-Value="user.UserName" />
            </div>

            <!-- Email -->
            <div>
                <label class="block font-medium mb-1">Email</label>
                <InputText class="w-full px-3 py-2 rounded bg-gray-100 border" @bind-Value="user.Email" />
            </div>

            <!-- Is Admin -->
            <div class="flex items-center gap-2">
                <label class="block font-medium">Is Admin?</label>
                <InputCheckbox @bind-Value="user.IsAdmin" />
            </div>

            <!-- Is Active -->
            <div class="flex items-center gap-2">
                <label class="block font-medium">Is Active?</label>
                <InputCheckbox @bind-Value="user.IsActive" />
            </div>

            <!-- Submit Button -->
            <button type="submit" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Save Changes
            </button>
        </div>
    </EditForm>
}

@code {
    [Parameter] public string? UserId { get; set; }
    private UserAdminDTO? user;
    private string? StatusMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && UserId != null)
        {
            user = await AdminUserService.GetUserById(UserId);
            StateHasChanged();
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream(10_000_000).ReadAsync(buffer);
        var fileName = $"{Guid.NewGuid()}.jpg";

        try
        {
            StatusMessage = "Uploading...";
            user!.ProfileImageUrl = await JS.InvokeAsync<string>(
                "firebaseHelpers.uploadToFirebase", buffer, fileName);
            StatusMessage = "Uploaded!";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Upload error: {ex.Message}";
        }
    }

    private async Task UpdateUser()
    {
        if (UserId is not null && user is not null)
        {
            await AdminUserService.UpdateUser(UserId, user);
            Navigation.NavigateTo("/admin/users");
        }
    }
}
