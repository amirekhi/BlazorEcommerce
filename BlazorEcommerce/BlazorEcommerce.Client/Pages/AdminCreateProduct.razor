@using BlazorEcommerce.Client.Services
@using BlazorEcommerce.DTOs.Entities
@using ClassLibrary1.DTOs.Entities
@using ClassLibrary1.Interfaces
@inject IClientProductService ProductService
@inject ICategoryService CategoryService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<h1 class="text-3xl font-semibold mb-6">@Title</h1>

<EditForm Model="productModel" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="block mb-1 font-medium">Name</label>
            <InputText class="w-full px-4 py-2 border rounded bg-gray-200" @bind-Value="productModel.Name" />
        </div>

        <div>
            <label class="block mb-1 font-medium">Price</label>
            <InputNumber class="w-full px-4 py-2 border rounded bg-gray-200" @bind-Value="productModel.Price" />
        </div>

        <div>
            <label class="block mb-1 font-medium">Stock</label>
            <InputNumber class="w-full px-4 py-2 border rounded bg-gray-200" @bind-Value="productModel.Stock" />
        </div>

        <div>
            <label class="block mb-1 font-medium">Category</label>
            <select class="w-full px-4 py-2 border rounded bg-gray-200"
                    @bind="productModel.CategoryId">
                <option value="">-- Select Category --</option>
                @foreach (var category in categories)
                {
                    <option value="@category.Id">@category.Name</option>
                }
            </select>
        </div>

        <div class="md:col-span-2">
            <label class="block mb-1 font-medium">Description</label>
            <InputTextArea class="w-full px-4 py-2 border rounded bg-gray-200 h-28" @bind-Value="productModel.Description" />
        </div>

        <div class="md:col-span-2">
            <label class="block mb-1 font-medium">Upload Image</label>
            <InputFile OnChange="HandleFileSelected" />
            @if (!string.IsNullOrWhiteSpace(StatusMessage))
            {
                <p class="text-sm text-gray-500 mt-1">@StatusMessage</p>
            }
        </div>

        <div class="md:col-span-2">
            <label class="block mb-1 font-medium">Image URL</label>
            <InputText class="w-full px-4 py-2 border rounded bg-gray-200" @bind-Value="productModel.ImageUrl" />
        </div>

        @if (!string.IsNullOrEmpty(productModel.ImageUrl))
        {
            <div class="md:col-span-2">
                <img src="@productModel.ImageUrl" alt="Product Image" class="w-48 rounded border" />
            </div>
        }
    </div>

    <div class="mt-6 flex justify-end">
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
            @ButtonText
        </button>
    </div>
</EditForm>

@code {
    [Parameter] public int? ProductId { get; set; }

    private ProductDTO productModel = new() { CreatedAt = DateTime.UtcNow };
    private List<CategoryDTO> categories = new();
    private string Title = "Create New Product";
    private string ButtonText = "Create Product";
    private string? StatusMessage;
    private bool isFirstRender = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && isFirstRender)
        {
            isFirstRender = false;

            try
            {
                categories = await CategoryService.GetAllAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine("Failed to fetch categories: " + ex.Message);
            }

            if (ProductId is not null)
            {
                var existing = await ProductService.GetProductById(ProductId.Value);
                if (existing != null)
                {
                    productModel = existing;
                    Title = "Edit Product";
                    ButtonText = "Update Product";
                }
                else
                {
                    Navigation.NavigateTo("/admin/Products", true);
                }
            }

            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (ProductId.HasValue)
            {
                await ProductService.EditProduct(ProductId.Value, productModel);
            }
            else
            {
                await ProductService.AddProduct(productModel);
            }

            Navigation.NavigateTo("/admin/Products", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to submit product: {ex.Message}");
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream(10_000_000).ReadAsync(buffer);
        var fileName = $"{Guid.NewGuid()}.jpg";

        try
        {
            StatusMessage = "Uploading...";
            productModel.ImageUrl = await JS.InvokeAsync<string>("firebaseHelpers.uploadToFirebase", buffer, fileName);
            StatusMessage = "Uploaded!";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Upload error: {ex.Message}";
        }
    }
}
