@page "/profile"

@using ClassLibrary1.DTOs.Entities
@using ClassLibrary1.Interfaces
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@inject IServiceProvider ServiceProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS

@rendermode InteractiveWebAssembly

<div class="max-w-2xl mx-auto min-h-[600px] my-20 px-6">
    <h2 class="text-4xl font-semibold text-center text-gray-900 mb-10">Your Profile</h2>

    @if (user == null)
    {
        <p class="text-center text-gray-500 text-lg">Loading your information...</p>
    }
    else
    {
        <EditForm Model="editModel" OnValidSubmit="HandleSubmit">
            <div class="bg-white shadow-2xl rounded-2xl p-8 space-y-6 border border-gray-200">
                <!-- Profile Picture -->
                <div class="text-center">
                    @if (!string.IsNullOrWhiteSpace(editModel.ProfileImageUrl))
                    {
                        <img src="@editModel.ProfileImageUrl" class="w-24 h-24 mx-auto rounded-full border mb-2" />
                    }
                    <label class="cursor-pointer inline-block px-4 py-2 text-sm border border-gray-300 rounded-xl bg-white text-black hover:bg-gray-100 transition">
                        Change Profile Image
                        <InputFile OnChange="HandleFileSelected" class="hidden" />
                    </label>
                    @if (!string.IsNullOrWhiteSpace(StatusMessage))
                    {
                        <p class="text-sm text-gray-600 mt-1">@StatusMessage</p>
                    }
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <InputText @bind-Value="editModel.Username"
                               class="w-full px-4 py-2 text-lg border bg-gray-200 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <InputText @bind-Value="editModel.Email"
                               class="w-full px-4 py-2 bg-gray-200 text-lg border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Created At</label>
                    <p class="px-4 py-2 bg-gray-100 rounded-xl text-gray-800 text-lg">
                        @user.CreatedAt.ToLocalTime().ToString("f")
                    </p>
                </div>

                <div class="flex flex-col sm:flex-row justify-between gap-4 pt-4 flex-wrap">
                    <button type="submit"
                            class="w-full sm:w-auto px-6 py-2 bg-black text-white text-lg rounded-xl hover:bg-gray-800 transition flex items-center justify-center gap-2"
                            disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span class="h-6 w-6 border-4 border-gray-300 border-t-transparent rounded-full animate-spin"></span>
                        }
                        Save Changes
                    </button>

                    <button type="button"
                            class="w-full sm:w-auto px-6 py-2 bg-red-600 text-white text-lg rounded-xl hover:bg-red-700 transition flex items-center justify-center gap-2"
                            @onclick="() => showDeleteModal = true"
                            disabled="@isProcessing">
                        Delete Account
                    </button>

                    <button type="button"
                            class="w-full sm:w-auto px-6 py-2 bg-yellow-500 text-white text-lg rounded-xl hover:bg-yellow-600 transition flex items-center justify-center gap-2"
                            @onclick="Logout"
                            disabled="@isProcessing">
                        Logout
                    </button>
                </div>
            </div>
        </EditForm>
    }
</div>

@if (showDeleteModal)
{
    <div class="fixed inset-0 bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md space-y-4">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Confirm Deletion</h3>
            <p class="text-gray-600">Please enter your password to delete your account.</p>

            <InputText @bind-Value="deletePassword"
                       type="password"
                       class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" />

            <div class="flex justify-end gap-4 pt-4">
                <button @onclick="CancelDelete"
                        class="px-4 py-2 bg-gray-300 text-gray-800 rounded-xl hover:bg-gray-400 transition"
                        disabled="@isProcessing">
                    Cancel
                </button>
                <button @onclick="ConfirmDelete"
                        class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition flex items-center justify-center gap-2"
                        disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span class="h-6 w-6 border-4 border-gray-300 border-t-transparent rounded-full animate-spin"></span>
                    }
                    Confirm Delete
                </button>
            </div>
        </div>
    </div>
}

@code {
    private IClientAccountRepository? _accountRepository;
    private UserProfileDto? user;
    private UpdateProfileDto editModel = new();
    private bool hasInitialized = false;
    private bool showDeleteModal = false;
    private string deletePassword = "";
    private bool isProcessing = false;
    private string? StatusMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasInitialized)
        {
            hasInitialized = true;

            _accountRepository = ServiceProvider.GetService(typeof(IClientAccountRepository)) as IClientAccountRepository;
            if (_accountRepository is null)
            {
                Console.WriteLine("IClientAccountRepository not found.");
                return;
            }

            try
            {
                user = await _accountRepository.GetCurrentUserAsync();
                if (user is not null)
                {
                    editModel = new UpdateProfileDto
                    {
                        Username = user.Username,
                        Email = user.Email,
                        ProfileImageUrl = user.ProfileImageUrl
                    };
                }
                else
                {
                    Navigation.NavigateTo($"/login?redirectUri=/profile", forceLoad: true);
                }

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Navigation.NavigateTo($"/login?redirectUri=/profile", forceLoad: true);
                Console.WriteLine($"Error fetching profile: {ex.Message}");
            }
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream(10_000_000).ReadAsync(buffer);
        var fileName = $"{Guid.NewGuid()}.jpg";

        try
        {
            StatusMessage = "Uploading...";
            editModel.ProfileImageUrl = await JS.InvokeAsync<string>(
                "firebaseHelpers.uploadToFirebase", buffer, fileName);
            StatusMessage = "Uploaded!";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Upload error: {ex.Message}";
        }
    }

    private async Task HandleSubmit()
    {
        if (_accountRepository is null) return;

        isProcessing = true;
        try
        {
            await _accountRepository.UpdateProfileAsync(editModel);
            Console.WriteLine("User updated.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating profile: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void CancelDelete()
    {
        deletePassword = "";
        showDeleteModal = false;
    }

    private async Task ConfirmDelete()
    {
        if (_accountRepository is null || string.IsNullOrWhiteSpace(deletePassword)) return;

        isProcessing = true;
        try
        {
            await _accountRepository.DeleteAccountAsync(deletePassword);
            Navigation.NavigateTo("/", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting account: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            showDeleteModal = false;
            deletePassword = "";
        }
    }

    private async Task Logout()
    {
        isProcessing = true;
        try
        {
            var http = ServiceProvider.GetService(typeof(HttpClient)) as HttpClient;
            if (http is not null)
            {
                await http.PostAsync("/api/account/logout", null);
            }
            Navigation.NavigateTo("/login", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout failed: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }
}
